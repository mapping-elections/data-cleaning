---
title: "New York Congressional Elections by County"
output: html_notebook
---

The aim of this notebook is to create a map of New York congressional elections at the county level.

```{r}
library(dplyr)
library(tidyr)
library(readr)
library(stringr)
nnv <- read_tsv("data-raw/nnv-tsv/all-votes.tsv")
troublesome_elections <- read_csv("data/troublesome_elections.csv")
join_table <- read_csv("data/ny_county_join_table.csv")
names(nnv) <- names(nnv) %>%
  str_to_lower() %>%
  str_replace_all("\\.", "") %>%
  str_replace_all("\\s", "_")
ny_congressional <- nnv %>%
  filter(office == "U.S. House of Representatives",
         state == "New York",
         !is.na(county),
         !id %in% troublesome_elections$election_id) 
ny_1800 <- ny_congressional %>% 
  filter(date == "1800",
         is.na(town),
         is.na(city))
ny_1800_sums <- ny_congressional %>% 
  filter(date == "1800") %>% 
  mutate(place = ifelse(is.na(town), city, town)) %>% 
  filter(!is.na(place)) %>% 
  group_by(id, district, county) %>% 
  summarize(vote_total_sum = sum(vote, na.rm = TRUE))
```

Check the county reported versus the county sums.

```{r}
ny_1800 %>% 
  group_by(id, district, county) %>% 
  summarize(vote_total_reported = sum(vote, na.rm = TRUE)) %>% 
  full_join(ny_1800_sums, by = c("id", "district", "county")) %>% 
  mutate(matches = vote_total_reported == vote_total_sum,
         difference = vote_total_reported - vote_total_sum) %>% 
  arrange(difference) 
```

There are some discrepencies, but it appears from comparing the two and checking NNV that we are fine with using the reported county totals, which are off by a few votes from the sums at most. (Albany is a special case where there is an error in my filtering because of the wards; the NNV record is correct.)

Now figure out who the leading candidates were.

```{r}
ny_1800 <- ny_1800 %>% 
  group_by(id, district, county) %>% 
  mutate(vote = if_else(is.na(vote), 0L, vote),
         vote_county = sum(vote, na.rm = TRUE),
         percentage_county = vote / vote_county,
         won_county = vote == max(vote, na.rm = TRUE)) %>% 
  group_by(id) %>% 
  mutate(vote_district_total = sum(vote)) %>% 
  group_by(id, name_id) %>% 
  mutate(vote_candidate_total = sum(vote),
         vote_candidate_percentage = round(vote_candidate_total / vote_district_total, 3),
         counties_won = sum(won_county)) %>% 
  group_by(id) %>% 
  mutate(won_election = vote_candidate_total == max(vote_candidate_total)) 
  
data_for_map <- ny_1800 %>% 
  group_by(id, affiliation, county) %>%
  summarize(vote = sum(vote)) %>% 
  spread(affiliation, vote, fill = 0) %>% 
  left_join(join_table, by = c("county" = "nnv_county")) %>% 
  select(-notes)
```


```{r}
library(USAboundaries)
counties_1800 <- us_counties("1800-07-04", states = "New York", resolution =)

counties_1800@data <- counties_1800@data %>% 
  left_join(data_for_map, by = c("name" = "ahcb_county"))

library(leaflet)

color_scale <- colorQuantile("Blues", counties_1800$Federalist)

leaflet(counties_1800) %>% 
  addPolygons(stroke = FALSE, smoothFactor = 0.5,
              color = ~color_scale(Federalist))
```

